Bootstrap: docker
From: ubuntu:22.04 
%labels
    Author "yibo"
    Version "1.0"

%post
    echo "APT update with retry..."
    for i in 1 2 3; do
        apt-get update && break || sleep 5
    done

    apt-get install -y \
        build-essential \
        cmake \
        git \
        libgtest-dev \
        && rm -rf /var/lib/apt/lists/*

    # build GTest
    cd /usr/src/gtest
    cmake -DCMAKE_CXX_FLAGS="-fPIC" .
    make
    cp lib/*.a /usr/lib

    # build your code
    cd /opt/app
    mkdir -p build
    rm -rf build/*
    cd build
    cmake ..
    make

%files
. /opt/app

%environment
    export PATH=/opt/app/build:$PATH

%runscript
    exec /opt/app/build/convert_grayscale "$@"

%test
    echo "=== Running tests ==="
    cd /opt/app/build
    ./test_grayscale > /opt/app/test_output.txt
    cat /opt/app/test_output.txt
